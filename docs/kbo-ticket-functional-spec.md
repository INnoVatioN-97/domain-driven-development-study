# KBO 티켓 예매 서비스 기능 명세서

## 1. 서비스 개요
- **서비스 소개**: KBO 정규·포스트시즌 전 구단을 통합 지원하는 티켓 예매 플랫폼.
- **주요 대상 사용자**: 국내 일반 야구팬.
- **서비스 범위**: 구단별 차별 없이 단일 브랜드, 관리자에 의한 경기 일정·좌석 등록.
- **운영 정책**
  - 정규시즌 일정은 경기 7일 전 공개.
  - 포스트시즌 일정은 정규시즌 종료(10월 말) 직후 공개.
  - 좌석 구조·등급·가격은 구단·경기별로 독립 설정 가능.

## 2. 사용자 및 접근 정책
- **회원 가입/인증**: 이메일 인증 필수, 휴면·탈퇴 관리 포함.
- **권한 구분**
  - 일반 회원: 경기 조회, 최대 4매 예매, 포인트 관리, 취소·변경 수행.
  - 비회원: 경기·좌석 정보 열람까지만 허용.
  - 관리자: 경기·좌석·프로모션 CRUD, 현황 및 보고서 열람.
  - 고객센터: 회원·예매 조회, 강제 취소, 알림 재발송.
- **보안**: 기본 접근제어 구성, 향후 2FA 확장 고려.

## 3. 도메인 구조 (DDD)
- **Bounded Context**
  1. **Member**: `Member` Aggregate(Email, PhoneNumber VO 포함), 포인트 지갑, 출석체크, 예매 이력 관리.
  2. **Performance Management**: `Performance`, `Seat`, `SeatGrade`, 프로모션 코드 Aggregate. 경기 일정, 공개 상태, 좌석 템플릿, 가격 정책 관리.
  3. **Reservation**: `Reservation`, `ReservationItem`, `Payment`, `QueueTicket` Aggregate. 예매 플로우, 좌석 잠금, 결제, 취소/변경 정책 담당.
- **데이터 접근 전략**: JPA를 통한 도메인 영속화, MyBatis로 예매 내역·보고서 등 조회 최적화.

## 4. 핵심 사용자 시나리오
### 4.1 회원 가입 및 계정 관리
1. 이메일 입력 → 인증 메일 발송 → 토큰 검증.
2. 이름·휴대폰 번호(PhoneNumber VO 검증) 등록, 기본 포인트 지갑 생성.
3. 출석체크: 하루 1회 포인트 적립 및 히스토리 저장.

### 4.2 경기·좌석 탐색
1. 정규/포스트시즌 경기 목록 조회(구단, 날짜, 타입 필터 제공).
2. 경기 상세 시 좌석 등급·가격·잔여 좌석 정보 제공.
3. 프론트는 잔여 좌석 API를 폴링하여 실시간 업데이트.

### 4.3 예매 플로우
1. 대기열 진입: 인기 경기 대비 선착순 정책 및 타임아웃 추적.
2. 좌석 선택: 좌석 잠금(Optimistic Lock 기본, 필요 시 Pessimistic Lock), 잠금 유지 시간 내 결제 완료 요구.
3. 결제: 서비스 포인트 사용, 잔액 검증, 최대 3회 자동 재시도.
4. 예매 확정: 좌석 상태 확정, Reservation·Payment 생성, 이메일 알림 발송.
5. 멱등성 키로 API 중복 호출 방지.

### 4.4 취소·변경
1. 경기 시작 24시간 전까지 수수료 0%, 이후 10% 차감.
2. 취소 시 포인트 환불, 좌석 상태 복원, 감사 로그 기록.
3. 변경은 취소 후 재예매 플로우 재사용.

### 4.5 포인트·프로모션
- 포인트 잔액 및 거래 내역 조회.
- 출석체크·프로모션 코드로 포인트 적립.
- 프로모션 코드: 구단/경기별 적용 범위, 사용 횟수, 유효 기간 관리.

## 5. 관리자 기능
- 경기 관리: 생성, 수정, 판매 상태 변경, 공개 일정 설정.
- 좌석 관리: 템플릿 업로드(CSV/JSON), 등급/가격 배정, 상태 일괄 변경.
- 프로모션 코드 관리: 생성, 배포, 사용 현황 확인.
- 예매 현황: 경기별 판매량, 환불, 잔여 좌석 대시보드.
- 보고서: 일·주·월 단위 매출, 포인트 사용, 취소 통계 CSV/Excel 다운로드.
- 감사 로그: 관리자·고객센터 조작 내역 저장.

## 6. 고객센터 기능
- 회원·예매 검색(이메일, 경기, 예약번호 기준).
- 예매 강제 취소, 알림 재발송, 포인트 정정(권한 제한).
- 처리 이력 자동 기록 및 담당자 표시.

## 7. 비기능 요구사항
- **동시성**: 인기 경기 기준 수백 QPS 처리 대비, 좌석 잠금과 대기열 큐 적용.
- **신뢰성**: 결제 실패 재시도 정책, 좌석 잠금 만료 시 자동 복구 배치.
- **로그/감사**: 예매·결제·관리자 조작 로그 1년 보관 후 파기 또는 백업.
- **모니터링**: 대기열 길이, 결제 실패율, 좌석 잠금 만료율 등 주요 지표 알림.
- **확장성**: 외부 PG 연동 대비 결제 추상화, 다국어·해외 확장 가능성 고려.

## 8. 인터페이스 및 아키텍처 구성
- REST API(interfaces/rest): 회원, 경기, 예매, 관리자/고객센터 엔드포인트.
- Application Service: 각 bounded context 유스케이스 구현 및 트랜잭션 조율.
- Domain Service: 좌석 잠금 정책, 수수료 계산, 멱등성 검증 등 공통 도메인 로직.
- Infrastructure: JPA Repository(영속화), MyBatis Mapper(조회), 메시징/이벤트(재시도 큐, 알림).

## 9. 향후 결정 필요 항목
1. 좌석 잠금 유지 시간, 대기열 정책 세부 파라미터 환경설정화.
2. 경기 일정 변경 시 예매자 알림 및 자동 환불 처리 정책 확정.
3. 프로모션 코드 중복 사용 규칙(회원/구단/경기 기준) 세분화.
4. 외부 PG 연동, 다국어 지원 등 확장 방향 확정 시 설계 반영.
5. SLA, 보안(2FA 등) 세부 정책 및 모니터링 기준 정의.
